<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleEvaluator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Card Fraud Rule Engine</a> &gt; <a href="index.source.html" class="el_package">com.fraud.engine.engine</a> &gt; <span class="el_source">RuleEvaluator.java</span></div><h1>RuleEvaluator.java</h1><pre class="source lang-java linenums">package com.fraud.engine.engine;

import com.fraud.engine.config.EvaluationConfig;
import com.fraud.engine.domain.DebugInfo;
import com.fraud.engine.domain.Decision;
import com.fraud.engine.domain.EngineMetadata;
import com.fraud.engine.domain.Rule;
import com.fraud.engine.domain.Ruleset;
import com.fraud.engine.domain.TimingBreakdown;
import com.fraud.engine.domain.TransactionContext;
import com.fraud.engine.util.EngineMetrics;
import com.fraud.engine.velocity.VelocityService;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import org.jboss.logging.Logger;

import java.util.List;
import java.util.Map;

@ApplicationScoped
<span class="fc" id="L21">public class RuleEvaluator {</span>

<span class="fc" id="L23">    private static final Logger LOG = Logger.getLogger(RuleEvaluator.class);</span>

    public static final String EVAL_AUTH = &quot;AUTH&quot;;
    public static final String EVAL_MONITORING = &quot;MONITORING&quot;;
    public static final String EVAL_REPLAY_MODE = &quot;REPLAY&quot;;

<span class="fc" id="L29">    private static final boolean STATIC_DEBUG_ENABLED = EvaluationConfig.isStaticDebugEnabled();</span>

<span class="fc" id="L31">    public enum EvaluationType {</span>
<span class="fc" id="L32">        AUTH, MONITORING, REPLAY;</span>

        public String getValue() {
<span class="fc" id="L35">            return name();</span>
        }
    }

    @Inject
    MonitoringEvaluator monitoringEvaluator;

    @Inject
    VelocityService velocityService;

    @Inject
    EvaluationConfig evaluationConfig;

    @Inject
    EngineMetrics engineMetrics;

    public Decision evaluate(TransactionContext transaction, Ruleset ruleset) {
<span class="fc" id="L52">        return evaluate(transaction, ruleset, false);</span>
    }

    public Decision evaluate(TransactionContext transaction, Ruleset ruleset, boolean replayMode) {
<span class="fc" id="L56">        long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L57">        long startNanos = System.nanoTime();</span>

<span class="fc" id="L59">        Decision decision = createDecision(transaction, ruleset, replayMode);</span>
<span class="fc" id="L60">        decision.setRulesetKey(ruleset.getKey());</span>
<span class="fc" id="L61">        decision.setRulesetVersion(ruleset.getVersion());</span>
<span class="fc" id="L62">        decision.setRulesetId(ruleset.getRulesetId());</span>

        // Initialize timing breakdown
<span class="fc" id="L65">        com.fraud.engine.domain.TimingBreakdown breakdown = new com.fraud.engine.domain.TimingBreakdown();</span>
<span class="fc" id="L66">        decision.setTimingBreakdown(breakdown);</span>

<span class="fc bfc" id="L68" title="All 2 branches covered.">        DebugInfo.Builder debugBuilder = shouldCaptureDebug()</span>
<span class="fc" id="L69">                ? createDebugBuilder(ruleset.getKey(), &quot;v&quot; + ruleset.getVersion())</span>
<span class="fc" id="L70">                : null;</span>

        try {
<span class="fc" id="L73">            Map&lt;String, Object&gt; evalContext = null;</span>
            // Keep AUTH map creation lazy: only build evaluation context when a rule/debug path needs it.
            // MONITORING/REPLAY still materialize the context because it's included in decision payloads.
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (!EVAL_AUTH.equalsIgnoreCase(ruleset.getEvaluationType())) {</span>
<span class="fc" id="L77">                evalContext = transaction.toEvaluationContext();</span>
<span class="fc" id="L78">                decision.setTransactionContext(evalContext);</span>
            }

            // Measure scope traversal (ADR-0015)
<span class="fc" id="L82">            long scopeStart = System.nanoTime();</span>
<span class="fc" id="L83">            List&lt;Rule&gt; rulesToEvaluate = ruleset.getApplicableRules(</span>
<span class="fc" id="L84">                    transaction.getCardNetwork(),</span>
<span class="fc" id="L85">                    transaction.getCardBin(),</span>
<span class="fc" id="L86">                    transaction.getMerchantCategoryCode(),</span>
<span class="fc" id="L87">                    transaction.getCardLogo()</span>
            );
<span class="fc" id="L89">            long scopeEnd = System.nanoTime();</span>
<span class="fc" id="L90">            breakdown.setScopeTraversalTimeMs((scopeEnd - scopeStart) / 1_000_000.0);</span>

<span class="fc bfc" id="L92" title="All 2 branches covered.">            if (rulesToEvaluate.isEmpty()) {</span>
<span class="fc" id="L93">                LOG.warnf(&quot;No rules to evaluate for ruleset: %s&quot;, ruleset.getFullKey());</span>
<span class="fc" id="L94">                decision.setDecision(Decision.DECISION_APPROVE);</span>
<span class="fc" id="L95">                return finalizeDecision(decision, startTime, debugBuilder);</span>
            }

            // Measure context creation
<span class="fc" id="L99">            long contextStart = System.nanoTime();</span>
<span class="fc" id="L100">            EvaluationContext context = EvaluationContext.create(</span>
<span class="fc" id="L101">                    transaction,</span>
<span class="fc" id="L102">                    ruleset,</span>
<span class="fc" id="L103">                    decision,</span>
<span class="fc" id="L104">                    replayMode,</span>
<span class="fc" id="L105">                    startTime,</span>
<span class="fc" id="L106">                    decision.getEngineMode(),</span>
<span class="fc" id="L107">                    debugBuilder,</span>
<span class="fc" id="L108">                    rulesToEvaluate,</span>
<span class="fc" id="L109">                    evalContext</span>
            );
<span class="fc" id="L111">            long contextEnd = System.nanoTime();</span>
<span class="fc" id="L112">            breakdown.setContextCreationTimeMs((contextEnd - contextStart) / 1_000_000.0);</span>

            // Measure dispatch evaluation
<span class="fc" id="L115">            long dispatchStart = System.nanoTime();</span>
<span class="fc" id="L116">            dispatchEvaluation(context);</span>
<span class="fc" id="L117">            long dispatchEnd = System.nanoTime();</span>
<span class="fc" id="L118">            breakdown.setDispatchEvaluationTimeMs((dispatchEnd - dispatchStart) / 1_000_000.0);</span>

<span class="pc" id="L120">        } catch (Exception e) {</span>
<span class="nc" id="L121">            LOG.errorf(e, &quot;Error during rule evaluation&quot;);</span>
<span class="nc" id="L122">            handleEvaluationError(decision, transaction, e);</span>
        }

        // Measure finalization
<span class="fc" id="L126">        long finalizeStart = System.nanoTime();</span>
<span class="fc" id="L127">        Decision finalDecision = finalizeDecision(decision, startTime, debugBuilder);</span>
<span class="fc" id="L128">        long finalizeEnd = System.nanoTime();</span>

        // Update timing breakdown with finalization time
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (finalDecision.getTimingBreakdown() != null) {</span>
<span class="fc" id="L132">            finalDecision.getTimingBreakdown().setDecisionFinalizationTimeMs((finalizeEnd - finalizeStart) / 1_000_000.0);</span>
        }

<span class="fc" id="L135">        return finalDecision;</span>
    }

    private Decision createDecision(TransactionContext transaction, Ruleset ruleset, boolean replayMode) {
<span class="fc" id="L139">        Decision decision = new Decision(transaction.getTransactionId(), ruleset.getEvaluationType());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        decision.setEngineMode(replayMode ? Decision.MODE_REPLAY : Decision.MODE_NORMAL);</span>
<span class="fc" id="L141">        return decision;</span>
    }

    private DebugInfo.Builder createDebugBuilder(String rulesetKey, String version) {
<span class="fc" id="L145">        return new DebugInfo.Builder()</span>
<span class="fc" id="L146">                .rulesetKey(rulesetKey)</span>
<span class="fc" id="L147">                .compiledRulesetVersion(version)</span>
<span class="fc" id="L148">                .compilationTimestamp(System.currentTimeMillis());</span>
    }

    private boolean shouldCaptureDebug() {
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (STATIC_DEBUG_ENABLED) {</span>
<span class="nc" id="L153">            return true;</span>
        }
<span class="pc bpc" id="L155" title="1 of 4 branches missed.">        return evaluationConfig != null &amp;&amp; evaluationConfig.shouldCaptureDebug();</span>
    }

    private void dispatchEvaluation(EvaluationContext context) {
<span class="fc" id="L159">        monitoringEvaluator.evaluate(context);</span>
<span class="fc" id="L160">    }</span>

    private Decision finalizeDecision(Decision decision, long startTime, DebugInfo.Builder debugBuilder) {
<span class="fc" id="L163">        long processingTimeMs = System.currentTimeMillis() - startTime;</span>
<span class="fc" id="L164">        decision.setProcessingTimeMs(processingTimeMs);</span>

<span class="fc" id="L166">        EngineMetadata engineMetadata = new EngineMetadata(</span>
<span class="fc" id="L167">                decision.getEngineMode(),</span>
<span class="fc" id="L168">                decision.getEngineErrorCode(),</span>
<span class="fc" id="L169">                decision.getEngineErrorMessage(),</span>
<span class="fc" id="L170">                processingTimeMs,</span>
<span class="fc" id="L171">                null</span>
        );
<span class="fc" id="L173">        decision.setEngineMetadata(engineMetadata);</span>

        // Preserve existing timing breakdown and update total
<span class="fc" id="L176">        TimingBreakdown timingBreakdown = decision.getTimingBreakdown();</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (timingBreakdown == null) {</span>
<span class="nc" id="L178">            timingBreakdown = new TimingBreakdown(processingTimeMs);</span>
<span class="nc" id="L179">            decision.setTimingBreakdown(timingBreakdown);</span>
<span class="nc" id="L180">        } else {</span>
<span class="fc" id="L181">            timingBreakdown.setTotalProcessingTimeMs(processingTimeMs);</span>
        }

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (debugBuilder != null) {</span>
<span class="fc" id="L185">            DebugInfo.EvaluationTiming timing = new DebugInfo.EvaluationTiming(</span>
<span class="fc" id="L186">                    null,</span>
<span class="fc" id="L187">                    processingTimeMs * 1_000_000,</span>
<span class="fc" id="L188">                    null</span>
            );
<span class="fc" id="L190">            debugBuilder.timing(timing);</span>
<span class="fc" id="L191">            decision.setDebugInfo(debugBuilder.build());</span>
        }

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="fc" id="L195">            LOG.debugf(&quot;Decision complete: id=%s, decision=%s, mode=%s, time=%dms&quot;,</span>
<span class="fc" id="L196">                    decision.getDecisionId(),</span>
<span class="fc" id="L197">                    decision.getDecision(),</span>
<span class="fc" id="L198">                    decision.getEngineMode(),</span>
<span class="fc" id="L199">                    decision.getProcessingTimeMs());</span>
        }
<span class="fc" id="L201">        return decision;</span>
    }

    private void handleEvaluationError(Decision decision, TransactionContext transaction, Exception e) {
<span class="nc" id="L205">        decision.setEngineErrorCode(&quot;EVALUATION_ERROR&quot;);</span>
<span class="nc" id="L206">        decision.setEngineErrorMessage(&quot;Error during rule evaluation: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (EVAL_MONITORING.equalsIgnoreCase(decision.getEvaluationType())) {</span>
<span class="nc" id="L208">            decision.setEngineMode(Decision.MODE_DEGRADED);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            String fallbackDecision = transaction != null ? transaction.getDecision() : null;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            decision.setDecision(fallbackDecision != null ? fallbackDecision : Decision.DECISION_APPROVE);</span>
<span class="nc" id="L211">            engineMetrics.incrementDegraded();</span>
<span class="nc" id="L212">            LOG.error(&quot;Monitoring evaluation error, returning DEGRADED decision envelope&quot;, e);</span>
<span class="nc" id="L213">            return;</span>
        }
<span class="nc" id="L215">        decision.setEngineMode(Decision.MODE_FAIL_OPEN);</span>
<span class="nc" id="L216">        decision.setDecision(Decision.DECISION_APPROVE);</span>
<span class="nc" id="L217">        engineMetrics.incrementFailOpen();</span>
<span class="nc" id="L218">        LOG.error(&quot;Evaluation error, defaulting to APPROVE (fail-open)&quot;, e);</span>
<span class="nc" id="L219">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>