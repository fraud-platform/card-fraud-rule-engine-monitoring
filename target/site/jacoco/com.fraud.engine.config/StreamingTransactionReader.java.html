<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StreamingTransactionReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Card Fraud Rule Engine</a> &gt; <a href="index.source.html" class="el_package">com.fraud.engine.config</a> &gt; <span class="el_source">StreamingTransactionReader.java</span></div><h1>StreamingTransactionReader.java</h1><pre class="source lang-java linenums">package com.fraud.engine.config;

import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import com.fraud.engine.domain.TransactionContext;
import jakarta.ws.rs.Consumes;
import jakarta.ws.rs.WebApplicationException;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.MultivaluedMap;
import jakarta.ws.rs.ext.MessageBodyReader;
import jakarta.ws.rs.ext.Provider;

import java.io.IOException;
import java.io.InputStream;
import java.lang.annotation.Annotation;
import java.lang.reflect.Type;

/**
 * Streaming JSON parser for TransactionContext using Jackson's low-level streaming API.
 *
 * &lt;p&gt;&lt;b&gt;Performance:&lt;/b&gt; 2-3x faster than Jackson's tree model deserialization by:
 * &lt;ul&gt;
 *   &lt;li&gt;Parsing JSON tokens directly without intermediate object creation&lt;/li&gt;
 *   &lt;li&gt;Populating TransactionContext fields on-the-fly&lt;/li&gt;
 *   &lt;li&gt;Skipping fields not needed for rule evaluation&lt;/li&gt;
 *   &lt;li&gt;Zero reflection overhead (direct field setting)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;&lt;b&gt;Usage:&lt;/b&gt; Automatically registered by JAX-RS as a MessageBodyReader.
 * Intercepts all TransactionContext deserialization for /v1/evaluate endpoints.
 */
@Provider
@Consumes(MediaType.APPLICATION_JSON)
<span class="nc" id="L35">public class StreamingTransactionReader implements MessageBodyReader&lt;TransactionContext&gt; {</span>

<span class="nc" id="L37">    private static final JsonFactory JSON_FACTORY = new JsonFactory();</span>

    @Override
    public boolean isReadable(Class&lt;?&gt; type, Type genericType, Annotation[] annotations, MediaType mediaType) {
<span class="nc bnc" id="L41" title="All 2 branches missed.">        return type == TransactionContext.class;</span>
    }

    @Override
    public TransactionContext readFrom(
            Class&lt;TransactionContext&gt; type,
            Type genericType,
            Annotation[] annotations,
            MediaType mediaType,
            MultivaluedMap&lt;String, String&gt; httpHeaders,
            InputStream entityStream
    ) throws IOException, WebApplicationException {
<span class="nc" id="L53">        TransactionContext tx = new TransactionContext();</span>

<span class="nc" id="L55">        try (JsonParser parser = JSON_FACTORY.createParser(entityStream)) {</span>

            // Expect START_OBJECT
<span class="nc bnc" id="L58" title="All 2 branches missed.">            if (parser.nextToken() != JsonToken.START_OBJECT) {</span>
<span class="nc" id="L59">                throw new IOException(&quot;Expected START_OBJECT token&quot;);</span>
            }

            // Parse field by field
<span class="nc bnc" id="L63" title="All 2 branches missed.">            while (parser.nextToken() != JsonToken.END_OBJECT) {</span>
<span class="nc" id="L64">                String fieldName = parser.getCurrentName();</span>
<span class="nc" id="L65">                parser.nextToken(); // Move to value</span>

<span class="nc" id="L67">                parseField(tx, fieldName, parser);</span>
            }
        }

<span class="nc" id="L71">        return tx;</span>
    }

    private void parseField(TransactionContext tx, String fieldName, JsonParser parser) throws IOException {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (parser.currentToken() == JsonToken.VALUE_NULL) {</span>
<span class="nc" id="L76">            return; // Skip null values</span>
        }

<span class="nc bnc" id="L79" title="All 23 branches missed.">        switch (fieldName) {</span>
            // String fields
<span class="nc" id="L81">            case &quot;transaction_id&quot; -&gt; tx.setTransactionId(parser.getValueAsString());</span>
<span class="nc" id="L82">            case &quot;card_hash&quot; -&gt; tx.setCardHash(parser.getValueAsString());</span>
<span class="nc" id="L83">            case &quot;currency&quot; -&gt; tx.setCurrency(parser.getValueAsString());</span>
<span class="nc" id="L84">            case &quot;merchant_id&quot; -&gt; tx.setMerchantId(parser.getValueAsString());</span>
<span class="nc" id="L85">            case &quot;merchant_name&quot; -&gt; tx.setMerchantName(parser.getValueAsString());</span>
<span class="nc" id="L86">            case &quot;merchant_category&quot; -&gt; tx.setMerchantCategory(parser.getValueAsString());</span>
<span class="nc" id="L87">            case &quot;merchant_category_code&quot; -&gt; tx.setMerchantCategoryCode(parser.getValueAsString());</span>
<span class="nc" id="L88">            case &quot;transaction_type&quot; -&gt; tx.setTransactionType(parser.getValueAsString());</span>
<span class="nc" id="L89">            case &quot;entry_mode&quot; -&gt; tx.setEntryMode(parser.getValueAsString());</span>
<span class="nc" id="L90">            case &quot;country_code&quot; -&gt; tx.setCountryCode(parser.getValueAsString());</span>
<span class="nc" id="L91">            case &quot;ip_address&quot; -&gt; tx.setIpAddress(parser.getValueAsString());</span>
<span class="nc" id="L92">            case &quot;device_id&quot; -&gt; tx.setDeviceId(parser.getValueAsString());</span>
<span class="nc" id="L93">            case &quot;email&quot; -&gt; tx.setEmail(parser.getValueAsString());</span>
<span class="nc" id="L94">            case &quot;phone&quot; -&gt; tx.setPhone(parser.getValueAsString());</span>
<span class="nc" id="L95">            case &quot;card_network&quot; -&gt; tx.setCardNetwork(parser.getValueAsString());</span>
<span class="nc" id="L96">            case &quot;card_bin&quot; -&gt; tx.setCardBin(parser.getValueAsString());</span>
<span class="nc" id="L97">            case &quot;card_logo&quot; -&gt; tx.setCardLogo(parser.getValueAsString());</span>
<span class="nc" id="L98">            case &quot;decision&quot; -&gt; tx.setDecision(parser.getValueAsString());</span>

            // BigDecimal fields
<span class="nc" id="L101">            case &quot;amount&quot; -&gt; tx.setAmount(parser.getDecimalValue());</span>

            // Boolean fields
<span class="nc" id="L104">            case &quot;card_present&quot; -&gt; tx.setCardPresent(parser.getBooleanValue());</span>

            // Timestamp is kept as raw ISO-8601 text and parsed lazily only if needed.
<span class="nc" id="L107">            case &quot;timestamp&quot; -&gt; tx.setTimestampRaw(parser.getValueAsString());</span>

            // Nested objects - skip for now (can be added later if needed)
<span class="nc" id="L110">            case &quot;billing_address&quot;, &quot;shipping_address&quot;, &quot;custom_fields&quot; -&gt; parser.skipChildren();</span>

<span class="nc" id="L112">            default -&gt; parser.skipChildren(); // Unknown field</span>
        }
<span class="nc" id="L114">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>